#!/bin/sh

. /etc/sd-chkcryptoboot/sd-chkcryptoboot.conf

cat /etc/sd-chkcryptoboot/sd-chkcryptoboot.motd
echo -e "\n";

if [ $SECTORS ]; then
	ACTUAL=$(dd if=/dev/disk/by-id/$BOOTDISKID bs=512 count=$SECTORS status=none | b2sum);
	SAVED=$(cat /etc/sd-chkcryptoboot/head.b2sum);
	if test "$ACTUAL" != "$SAVED"; then 
		echo "ATTENTION: sd-chkcryptoboot: wrong head.b2sum";
	fi
	echo "HEADCHECK: OK";
fi

if [ $ESPPART ]; then
	SAVED=$(cat /etc/sd-chkcryptoboot/efi.b2sum);
	mkdir /tmp/efi;
	mount /dev/disk/by-id/$BOOTDISKID-part$ESPPART /tmp/efi;

	if [ $EFIPATH ]; then
		ACTUAL=$(dd if=/tmp/efi/$EFIPATH bs=4M status=none | b2sum);
	else
		ACTUAL=$(dd if=/dev/disk/by-id/$BOOTDISKID-part$ESPPART bs=4M status=none | b2sum);
	fi

	if test "$ACTUAL" != "$SAVED"; then 
		echo "ATTENTION: sd-chkcryptoboot: wrong efi.b2sum";
	fi
	umount /tmp/efi;
	echo "EFICHECK: OK";
fi

ACTUAL=$(lsusb | b2sum)
SAVED=$(cat /etc/sd-chkcryptoboot/lsusb.b2sum)
if test "$ACTUAL" != "$SAVED"; then 
	echo "ATTENTION: sd-chkcryptoboot: wrong lsusb.b2sum";
fi
echo "USBCHECK: OK";

ACTUAL=$(lspci | b2sum)
SAVED=$(cat /etc/sd-chkcryptoboot/lspci.b2sum)
if test "$ACTUAL" != "$SAVED"; then 
	echo "ATTENTION: sd-chkcryptoboot: wrong lspci.b2sum";
fi
echo "PCICHECK: OK";

ACTUAL=$(lsblk -Snrx SERIAL -o MODEL,SERIAL,SIZE,WWN,HCTL,\
TRAN,SUBSYSTEMS,REV,VENDOR | b2sum)
SAVED=$(cat /etc/sd-chkcryptoboot/lsblk.b2sum)
if test "$ACTUAL" != "$SAVED"; then 
	echo "ATTENTION: sd-chkcryptoboot: wrong lsblk.b2sum";
fi
echo "DISKSCHECK: OK";

for p in $(cat /proc/cmdline); do
	if test "$p" = "$CMDLINE_NAME=$CMDLINE_VALUE"; then
		echo "CMDLINE-CHECK: OK"; exit 0;
	fi
done
echo "ATTENTION: sd-chkcryptoboot: wrong cmdline"; exit 0
